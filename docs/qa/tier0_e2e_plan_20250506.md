# PhiloGraph Tier 0 MVP - End-to-End (E2E) Test Plan

**Date:** 2025-05-06
**Project:** PhiloGraph Tier 0 MVP
**Branch:** `feature/relationship-service`
**Tester:** Roo (Debug Mode)

## 1. Objective

To perform comprehensive end-to-end testing of the PhiloGraph Tier 0 MVP core functionalities through its Command Line Interface (CLI) and MCP Server Interface. This includes verifying ingestion, search, and acquisition workflows, as well as basic error handling.

## 2. Prerequisites

*   **Codebase:** Latest version of the `feature/relationship-service` branch is checked out.
*   **Environment:**
    *   Docker environment is up and running (`docker-compose up -d`). All services (philograph-backend, philograph-db, litellm-proxy) are healthy.
    *   Sample documents are available for ingestion:
        *   PDF: `./test_data/3505318.pdf` (The Burnout Society)
        *   EPUB: `./test_data/3402079.epub` (The Burnout Society)
        *   (TXT file testing deferred as per user instruction)
    *   External `zlibrary-mcp` server is running and configured for full acquisition workflow testing. (Assumed working for planning purposes; tests may be marked 'Blocked' if server issues persist).
*   **Reference Documents:**
    *   [`docs/project-specifications.md`](docs/project-specifications.md)
    *   [`README.md`](README.md)
    *   [`src/philograph/cli/main.py`](src/philograph/cli/main.py) (for CLI command structure)
    *   [`src/philograph/mcp/main.py`](src/philograph/mcp/main.py) (for MCP tool names and parameters)

## 3. Scope of Testing

*   **In Scope:**
    *   CLI functionality for Ingest, Search, Acquire (Discover, Confirm, Status).
    *   MCP Server tool functionality for `philograph_ingest`, `philograph_search`, `philograph_acquire`.
    *   Basic positive test cases (successful operations).
    *   Basic negative test cases (e.g., file not found, invalid filters, invalid IDs).
    *   Verification of outputs and system state changes (e.g., database entries, file system changes where applicable).
*   **Out of Scope (for Tier 0 E2E):**
    *   Exhaustive performance testing.
    *   Security vulnerability testing (beyond basic input validation if observable).
    *   Complex data integrity checks across all database tables.
    *   UI testing (as no UI is part of Tier 0).
    *   Testing of underlying library robustness (e.g., detailed testing of `semchunk` or `GROBID` beyond PhiloGraph's use of them).

## 4. Test Scenarios

### 4.1. Ingestion (`ingest` command / `philograph_ingest` tool)

**Sample Files:**
*   `PDF_SAMPLE = "./test_data/3505318.pdf"`
*   `EPUB_SAMPLE = "./test_data/3402079.epub"`
*   `TEST_DIR = "./test_data/"` (containing the PDF and EPUB)
*   `NON_EXISTENT_FILE = "./test_data/non_existent.pdf"`
*   `EMPTY_DIR = "./empty_test_dir/"` (To be created manually for testing)
*   `MIXED_TEST_DIR = "./mixed_test_data/"` (To be created with PDF, EPUB, and a dummy.zip for testing)

| Test ID      | Interface | Scenario                                      | Steps                                                                                                | Expected Result                                                                                                                               |
| :----------- | :-------- | :-------------------------------------------- | :--------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------- |
| **ING-CLI-001** | CLI       | Ingest a single PDF file                      | `python -m src.philograph.cli.main ingest --path {PDF_SAMPLE}`                                       | Success message. Document processed and indexed. Verify relevant DB entries (documents, chunks, embeddings - high level).                       |
| **ING-CLI-002** | CLI       | Ingest a single EPUB file                     | `python -m src.philograph.cli.main ingest --path {EPUB_SAMPLE}`                                      | Success message. Document processed and indexed. Verify relevant DB entries.                                                                  |
| **ING-CLI-003** | CLI       | Ingest a directory with mixed supported files | `python -m src.philograph.cli.main ingest --path {TEST_DIR}`                                         | Success messages for each supported file. Both PDF and EPUB processed. Verify DB entries.                                                     |
| **ING-CLI-004** | CLI       | Ingest a non-existent file                    | `python -m src.philograph.cli.main ingest --path {NON_EXISTENT_FILE}`                                | Error message indicating file not found. No changes to DB.                                                                                    |
| **ING-CLI-005** | CLI       | Ingest an empty directory                     | Create `EMPTY_DIR`. `python -m src.philograph.cli.main ingest --path {EMPTY_DIR}`                      | Message indicating no files processed or appropriate warning. No errors. No changes to DB.                                                    |
| **ING-CLI-006** | CLI       | Ingest directory with mixed (supported/unsupported) files | Create `MIXED_TEST_DIR` with `PDF_SAMPLE`, `EPUB_SAMPLE`, and `dummy.zip`. `python -m src.philograph.cli.main ingest --path {MIXED_TEST_DIR}` | Success messages for PDF & EPUB. Message for skipping ZIP. Verify DB entries for PDF/EPUB. No DB entry for ZIP. No errors. |
| **ING-MCP-001** | MCP       | Ingest a single PDF file                      | Tool: `philograph_ingest`, Args: `{"path": "{PDF_SAMPLE}"}`                                            | Successful response. Document processed. Verify DB entries.                                                                                   |
| **ING-MCP-002** | MCP       | Ingest a single EPUB file                     | Tool: `philograph_ingest`, Args: `{"path": "{EPUB_SAMPLE}"}`                                           | Successful response. Document processed. Verify DB entries.                                                                                   |
| **ING-MCP-003** | MCP       | Ingest a directory with mixed supported files | Tool: `philograph_ingest`, Args: `{"path": "{TEST_DIR}"}`                                              | Successful response (or individual responses if batched). Both files processed. Verify DB entries.                                            |
| **ING-MCP-004** | MCP       | Ingest a non-existent file                    | Tool: `philograph_ingest`, Args: `{"path": "{NON_EXISTENT_FILE}"}`                                     | Error response indicating file not found.                                                                                                     |
| **ING-MCP-005** | MCP       | Ingest an unsupported file type (e.g., .zip)  | Create dummy.zip. Tool: `philograph_ingest`, Args: `{"path": "./test_data/dummy.zip"}`                 | Message indicating file type not supported, skipped. No error.                                                                                |
| **ING-MCP-006** | MCP       | Ingest directory with mixed (supported/unsupported) files | Create `MIXED_TEST_DIR` with `PDF_SAMPLE`, `EPUB_SAMPLE`, `dummy.zip`. Tool: `philograph_ingest`, Args: `{"path": "{MIXED_TEST_DIR}"}` | Successful response for PDF/EPUB. Message for skipping ZIP. Verify DB entries for PDF/EPUB. No DB entry for ZIP. No errors. |

#### 4.1.1. Preprocessing and Chunking Verification

**Objective:** To manually inspect and verify the intermediate outputs of the document preprocessing and chunking stages within the ingestion pipeline. This helps ensure content is handled as expected and allows for identification of potential issues or areas for optimization.

| Test ID         | Interface | Scenario                                       | Steps                                                                                                                                                                                             | Expected Result                                                                                                                                                                                                                                                           |
| :-------------- | :-------- | :--------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **ING-PCV-001** | Manual    | Verify PDF preprocessing (text extraction)     | 1. Ingest `PDF_SAMPLE`. <br> 2. If possible, enable/access debug logs or intermediate text output from the PDF parsing stage (e.g., output of PyMuPDF). <br> 3. Manually compare extracted text to original PDF content for accuracy (spot check key sections). | Extracted text should largely match the original PDF content, preserving structure where feasible. Note any significant discrepancies, garbled text, or missing sections.                                                                                             |
| **ING-PCV-002** | Manual    | Verify EPUB preprocessing (text extraction)    | 1. Ingest `EPUB_SAMPLE`. <br> 2. If possible, enable/access debug logs or intermediate text output from the EPUB parsing stage (e.g., output of ebooklib). <br> 3. Manually compare extracted text to original EPUB content for accuracy (spot check key sections). | Extracted text should largely match the original EPUB content. HTML tags should be appropriately handled (e.g., stripped or converted to Markdown). Note any significant discrepancies or loss of content.                                                              |
| **ING-PCV-003** | Manual    | Verify chunking strategy for PDF               | 1. Ingest `PDF_SAMPLE`. <br> 2. Inspect the `chunks` table in the database for the ingested document. <br> 3. Review the content of several chunks. <br> 4. Assess chunk boundaries: Do they make logical sense (e.g., not cutting off sentences mid-way, respecting paragraph breaks if possible)? <br> 5. Assess chunk size: Are chunks within expected size limits? | Chunks should represent meaningful segments of the document. Boundaries should be logical. Chunk sizes should be consistent with configuration. Note any overly small/large chunks or awkward splits.                                                              |
| **ING-PCV-004** | Manual    | Verify chunking strategy for EPUB              | 1. Ingest `EPUB_SAMPLE`. <br> 2. Inspect the `chunks` table in the database for the ingested document. <br> 3. Review the content of several chunks. <br> 4. Assess chunk boundaries and size as per ING-PCV-003.                                                  | Chunks should represent meaningful segments of the document. Boundaries should be logical. Chunk sizes should be consistent with configuration. Note any overly small/large chunks or awkward splits, especially around HTML structural elements if not handled by preprocessing. |
| **ING-PCV-005** | Manual    | Verify metadata extraction (if applicable)     | 1. Ingest `PDF_SAMPLE` and `EPUB_SAMPLE`. <br> 2. Inspect the `documents` table for entries corresponding to these files. <br> 3. Check for extracted metadata (e.g., title, author from file properties or content).                                          | Basic metadata (if extraction is implemented in Tier 0) should be present and accurate. If no metadata extraction is expected, this can be N/A.                                                                                                         |

**Notes:**
*   These tests may require access to debug logs, intermediate file outputs, or direct database access.
*   The feasibility of some steps depends on the current observability of the ingestion pipeline.
*   If direct observation is difficult, consider recommending development tasks to expose this information for easier debugging and QA.
### 4.2. Search (`search` command / `philograph_search` tool)

*Assumes documents from ING-CLI-001 & ING-CLI-002 (or MCP equivalents) are ingested.*

| Test ID      | Interface | Scenario                                 | Steps                                                                                                   | Expected Result                                                                                                                                  |
| :----------- | :-------- | :--------------------------------------- | :------------------------------------------------------------------------------------------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------- |
| **SCH-CLI-001** | CLI       | Basic semantic search (query only)       | `python -m src.philograph.cli.main search --query "burnout"`                                            | Returns relevant search results (chunks) from ingested documents. Output format is readable.                                                     |
| **SCH-CLI-002** | CLI       | Search with author filter                | `python -m src.philograph.cli.main search --query "society" --author "Byung-Chul Han"`                  | Returns relevant results, filtered by author.                                                                                                    |
| **SCH-CLI-003** | CLI       | Search with year filter                  | `python -m src.philograph.cli.main search --query "philosophy" --year 2015`                             | Returns relevant results, filtered by year.                                                                                                      |
| **SCH-CLI-004** | CLI       | Search with non-matching filter          | `python -m src.philograph.cli.main search --query "burnout" --author "Plato"`                           | No results found, or appropriate message. No errors.                                                                                             |
| **SCH-CLI-005** | CLI       | Search with invalid filter format (year) | `python -m src.philograph.cli.main search --query "burnout" --year "abc"`                               | Error message indicating invalid year format.                                                                                                    |
| **SCH-CLI-006** | CLI       | Search with no query (should be error)   | `python -m src.philograph.cli.main search`                                                              | Error message indicating query is required.                                                                                                      |
| **SCH-MCP-001** | MCP       | Basic semantic search (query only)       | Tool: `philograph_search`, Args: `{"query": "burnout"}`                                                 | Successful response with relevant search results.                                                                                                |
| **SCH-MCP-002** | MCP       | Search with author filter                | Tool: `philograph_search`, Args: `{"query": "society", "filters": {"author": "Byung-Chul Han"}}`         | Successful response with relevant, author-filtered results.                                                                                      |
| **SCH-MCP-003** | MCP       | Search with year filter                  | Tool: `philograph_search`, Args: `{"query": "philosophy", "filters": {"year": 2015}}`                   | Successful response with relevant, year-filtered results.                                                                                        |
| **SCH-MCP-004** | MCP       | Search with non-matching filter          | Tool: `philograph_search`, Args: `{"query": "burnout", "filters": {"author": "Plato"}}`                 | Successful response, empty result set or appropriate message.                                                                                    |
| **SCH-MCP-005** | MCP       | Search with invalid filter value (year)  | Tool: `philograph_search`, Args: `{"query": "burnout", "filters": {"year": "abc"}}`                     | Error response indicating invalid filter value/format.                                                                                           |
| **SCH-MCP-006** | MCP       | Search with no query                     | Tool: `philograph_search`, Args: `{}`                                                                   | Error response indicating query is required.                                                                                                     |

### 4.3. Acquisition (`acquire` command / `philograph_acquire` tool)

*These tests depend on the `zlibrary-mcp` server. Mark as 'Blocked' if server is unavailable/unstable.*
*Assume `DISCOVERY_ID` is an ID obtained from a successful `discover` step.*
*Assume `ITEM_HASH` is a hash/identifier for an item within discovery results.*

| Test ID      | Interface | Scenario                                      | Steps                                                                                                                      | Expected Result                                                                                                                                                              |
| :----------- | :-------- | :-------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ACQ-CLI-001** | CLI       | Discover acquisition by title/author          | `python -m src.philograph.cli.main acquire discover --title "Psychopolitics" --author "Byung-Chul Han"`                    | Success message. Displays list of potential candidates from `zlibrary-mcp`. Returns a `discovery_id`.                                                                        |
| **ACQ-CLI-002** | CLI       | Confirm acquisition for a discovered item     | (Requires `DISCOVERY_ID` and `ITEM_HASH` from ACQ-CLI-001) `python -m src.philograph.cli.main acquire confirm {DISCOVERY_ID} --item-hash {ITEM_HASH}` | Success message. Acquisition job initiated. Returns an `acquisition_job_id`.                                                                                                 |
| **ACQ-CLI-003** | CLI       | Check status of an acquisition job (pending)  | (Requires `acquisition_job_id` from ACQ-CLI-002) `python -m src.philograph.cli.main acquire status {ACQUISITION_JOB_ID}`    | Status message indicating "pending" or "processing".                                                                                                                         |
| **ACQ-CLI-004** | CLI       | Check status of a completed acquisition job   | (Simulate completion or use a known completed ID) `python -m src.philograph.cli.main acquire status {COMPLETED_JOB_ID}` | Status message indicating "completed". Downloaded file exists in expected location (e.g., `./test_data/acquired/` or similar, verify spec). Ingestion may be part of this. |
| **ACQ-CLI-005** | CLI       | Discover with no results                      | `python -m src.philograph.cli.main acquire discover --title "NonExistentBookXYZ123"`                                       | Message indicating no results found. No error.                                                                                                                               |
| **ACQ-CLI-006** | CLI       | Confirm with invalid discovery ID             | `python -m src.philograph.cli.main acquire confirm invalid-discovery-id --item-hash some-hash`                             | Error message indicating invalid discovery ID.                                                                                                                               |
| **ACQ-CLI-007** | CLI       | Status with invalid job ID                    | `python -m src.philograph.cli.main acquire status invalid-job-id`                                                          | Error message indicating invalid job ID or job not found.                                                                                                                    |
| **ACQ-MCP-001** | MCP       | Discover acquisition by title/author          | Tool: `philograph_acquire`, Args: `{"filters": {"title": "Psychopolitics", "author": "Byung-Chul Han"}}`                   | Successful response with candidate list and `discovery_id`.                                                                                                                  |
| **ACQ-MCP-002** | MCP       | Confirm acquisition for a discovered item     | Tool: `philograph_acquire`, Args: `{"discovery_id": "{DISCOVERY_ID}", "selected_items": [{"item_hash": "{ITEM_HASH}"}]}`    | Successful response with `acquisition_job_id`.                                                                                                                               |
| **ACQ-MCP-003** | MCP       | Check status of an acquisition job            | Tool: `philograph_acquire`, Args: `{"acquisition_job_id": "{ACQUISITION_JOB_ID}"}`                                          | Successful response with job status (pending, completed, failed).                                                                                                            |
| **ACQ-MCP-004** | MCP       | Discover with no results                      | Tool: `philograph_acquire`, Args: `{"filters": {"title": "NonExistentBookXYZ123"}}`                                        | Successful response, empty candidate list.                                                                                                                                   |
| **ACQ-MCP-005** | MCP       | Confirm with invalid discovery ID             | Tool: `philograph_acquire`, Args: `{"discovery_id": "invalid-discovery-id", "selected_items": [{"item_hash": "some-hash"}]}` | Error response indicating invalid discovery ID.                                                                                                                              |

## 5. Test Execution and Reporting

*   Tests will be executed manually following the steps outlined above.
*   Results (Pass/Fail/Blocked), actual outcomes, and any deviations will be recorded.
*   Screenshots and log snippets should be captured for failures or unexpected behavior.
*   A final QA report (`docs/qa/tier0_e2e_report_20250506.md`) will summarize the execution and findings.

## 6. Known Issues / Skips from Unit/Integration Tests

*   7 CLI acquire tests skipped due to Typer issue `CLI-ACQUIRE-TYPER-INTRACTABLE-20250505`. E2E tests for acquire CLI will attempt to cover these flows manually.
*   1 utils test skipped (unrelated to core E2E functionality).
